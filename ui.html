<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoBrain Q&A</title>
    <!-- 1. Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
    <style>
        /* Use the Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        /* Custom scrollbar for chat */
        #chat-box::-webkit-scrollbar {
            width: 6px;
        }
        #chat-box::-webkit-scrollbar-track {
            background: #374151; /* bg-gray-700 */
            border-radius: 10px;
        }
        #chat-box::-webkit-scrollbar-thumb {
            background: #9CA3AF; /* bg-gray-400 */
            border-radius: 10px;
        }
        #chat-box::-webkit-scrollbar-thumb:hover {
            background: #F9FAFB; /* bg-gray-50 */
        }
        /* Chat bubble styles */
        .chat-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 16px;
            margin-bottom: 8px;
            word-wrap: break-word;
        }
        .user-bubble {
            background-color: #3B82F6; /* bg-blue-600 */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .bot-bubble {
            background-color: #374151; /* bg-gray-700 */
            color: #F9FAFB; /* text-gray-50 */
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        /* Simple loading spinner */
        .loader {
            width: 20px;
            height: 20px;
            border: 3px solid #4B5563; /* border-gray-600 */
            border-top-color: #F9FAFB; /* border-t-gray-50 */
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-100">

    <div class="flex flex-col h-screen max-w-3xl mx-auto p-4">
        
        <!-- Header -->
        <header class="text-center py-4 border-b border-gray-700">
            <h1 class="text-3xl font-bold">AutoBrain ðŸ§  Q&A</h1>
            <p class="text-gray-400">Your personal Codebasics FAQ assistant</p>
        </header>

        <!-- Setup Section -->
        <div class="p-4 bg-gray-800 rounded-lg my-4 shadow-lg">
            <h2 class="text-lg font-semibold mb-3">Setup</h2>
            <div class="flex flex-col sm:flex-row gap-4">
                <!-- API Key Input Removed -->
                
                <!-- CSV File Upload -->
                <div class="flex-1">
                    <label for="csv-file-input" class="block text-sm font-medium text-gray-300 mb-1">1. Upload FAQ CSV</label>
                    <input type="file" id="csv-file-input" accept=".csv" class="w-full text-sm text-gray-300
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-md file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-600 file:text-white
                        hover:file:bg-blue-700 file:cursor-pointer
                        bg-gray-700 rounded-md border border-gray-600 cursor-pointer">
                </div>
            </div>
            <p id="status-message" class="text-sm text-green-400 mt-3"></p>
        </div>

        <!-- Chat Box -->
        <main id="chat-box" class="flex-1 overflow-y-auto p-4 bg-gray-800 rounded-lg shadow-inner flex flex-col space-y-2">
            <!-- Initial Bot Message -->
            <div class="chat-bubble bot-bubble">
                Hello! Please enter your API key and upload your `codebasics_faqs.csv` file to get started.
            </div>
            <!-- Chat messages will be dynamically added here -->
        </main>

        <!-- Input Area -->
        <footer class="py-4">
            <div class="flex gap-2">
                <input type="text" id="chat-input" placeholder="Ask your question..." class="flex-1 p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                <button id="send-button" class="bg-blue-600 text-white px-5 py-3 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Send
                </button>
            </div>
        </footer>

    </div>

    <!-- 3. Main Application Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- DOM Elements ---
            const chatBox = document.getElementById('chat-box');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            // const apiKeyInput = document.getElementById('api-key-input'); // Removed
            const csvFileInput = document.getElementById('csv-file-input');
            const statusMessage = document.getElementById('status-message');

            // --- Application State ---
            const apiKey = "AIzaSyB0wT4y1JV7dq-ZErTydtq25arO0oA1ASE"; // API Key hardcoded
            let faqData = [];
            let isLoading = false;
            
            // --- Prompt Template from your Python code ---
            const PROMPT_TEMPLATE = `Given the following context and a question, generate an answer based on this context only.
In the answer try to provide as much text as possible from "response" section in the source document context without making much changes.
If the answer is not found in the context, kindly state "I don't know." Don't try to make up an answer.

CONTEXT: {context}

QUESTION: {question}`;

            // --- Event Listeners ---

            // Enable/disable inputs based on setup
            function checkSetup() {
                if (apiKey && faqData.length > 0) { // apiKey is now always true
                    chatInput.disabled = false;
                    sendButton.disabled = false;
                    statusMessage.textContent = `Ready! ${faqData.length} FAQs loaded.`;
                    statusMessage.classList.remove('text-red-400');
                    statusMessage.classList.add('text-green-400');
                } else {
                    chatInput.disabled = true;
                    sendButton.disabled = true;
                    // Updated error message
                    let errorMsg = 'FAQ file is not loaded.';
                    statusMessage.textContent = errorMsg;
                    statusMessage.classList.remove('text-green-400');
                    statusMessage.classList.add('text-red-400');
                }
            }

            // 1. Handle API Key Input - Removed
            // apiKeyInput.addEventListener('change', () => {
            //     apiKey = apiKeyInput.value.trim();
            //     checkSetup();
            // });

            // 2. Handle File Upload
            csvFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    statusMessage.textContent = 'Parsing CSV file...';
                    Papa.parse(file, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            // Store only rows that have a 'prompt'
                            faqData = results.data.filter(row => row.prompt && row.prompt.trim() !== '');
                            if (faqData.length > 0) {
                                console.log(`Loaded ${faqData.length} FAQs.`);
                                checkSetup();
                            } else {
                                faqData = [];
                                statusMessage.textContent = "CSV loaded, but no valid 'prompt' data found.";
                                statusMessage.classList.add('text-red-400');
                                checkSetup();
                            }
                        },
                        error: (err) => {
                            console.error('PapaParse Error:', err);
                            statusMessage.textContent = `Error parsing CSV: ${err.message}`;
                            statusMessage.classList.add('text-red-400');
                            faqData = [];
                            checkSetup();
                        }
                    });
                }
            });

            // 3. Handle Send Button Click
            sendButton.addEventListener('click', handleSend);
            chatInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter' && !isLoading) {
                    handleSend();
                }
            });

            // --- Core Functions ---

            /**
             * Handles sending the user's question to the AI
             */
            async function handleSend() {
                const question = chatInput.value.trim();
                if (!question || isLoading) return;

                addMessageToChat(question, 'user');
                chatInput.value = '';
                setLoading(true);

                try {
                    // 1. Find relevant context (replaces FAISS search)
                    const context = findRelevantContext(question, 5);
                    
                    // 2. Format the prompt
                    const finalPrompt = PROMPT_TEMPLATE
                        .replace('{context}', context)
                        .replace('{question}', question);

                    // 3. Call the Gemini API
                    const answer = await callGeminiAPI(finalPrompt);
                    addMessageToChat(answer, 'bot');

                } catch (error) {
                    console.error('Error in handleSend:', error);
                    addMessageToChat(`Sorry, an error occurred: ${error.message}`, 'bot');
                } finally {
                    setLoading(false);
                }
            }

            /**
             * Adds a message bubble to the chat UI
             */
            function addMessageToChat(message, sender) {
                const bubble = document.createElement('div');
                bubble.classList.add('chat-bubble', sender === 'user' ? 'user-bubble' : 'bot-bubble');
                
                // Sanitize and format text (simple version)
                const textNode = document.createElement('div');
                textNode.innerHTML = message.replace(/\n/g, '<br>'); // Render newlines
                bubble.appendChild(textNode);
                
                chatBox.appendChild(bubble);
                scrollToBottom();
            }

            /**
             * Adds/Removes a loading indicator
             */
            function setLoading(loading) {
                isLoading = loading;
                sendButton.disabled = loading;
                if (loading) {
                    // Add loader to chat
                    const loaderBubble = document.createElement('div');
                    loaderBubble.id = 'loader-bubble';
                    loaderBubble.classList.add('chat-bubble', 'bot-bubble');
                    const loader = document.createElement('div');
                    loader.classList.add('loader');
                    loaderBubble.appendChild(loader);
                    chatBox.appendChild(loaderBubble);
                    scrollToBottom();
                } else {
                    // Remove loader
                    const loaderBubble = document.getElementById('loader-bubble');
                    if (loaderBubble) {
                        chatBox.removeChild(loaderBubble);
                    }
                }
            }
            
            /**
             * Scrolls the chat box to the bottom
             */
            function scrollToBottom() {
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            /**
             * A simple text search to find relevant context from the CSV data
             * This replaces the vector search from your original code.
             */
            function findRelevantContext(question, topK = 3) {
                const questionWords = question.toLowerCase().split(/\s+/).filter(w => w.length > 2); // Simple tokenizer

                const scoredDocs = faqData.map(row => {
                    let score = 0;
                    const promptText = row.prompt ? row.prompt.toLowerCase() : '';
                    
                    // Score based on keyword matches in the 'prompt'
                    for (const word of questionWords) {
                        if (promptText.includes(word)) {
                            score++;
                        }
                    }
                    return { ...row, score };
                });

                // Sort by score and take the top K
                const topDocs = scoredDocs.sort((a, b) => b.score - a.score).slice(0, topK);

                // Format the context for the LLM
                // We only include docs that have some score
                const context = topDocs
                    .filter(doc => doc.score > 0)
                    .map(doc => `prompt: ${doc.prompt}\nresponse: ${doc.response}`)
                    .join('\n\n');
                
                return context || "No relevant context found.";
            }

            /**
             * Calls the Google Gemini API with exponential backoff.
             * This re-implements the ChatGoogleGenerativeAI call.
             */
            async function callGeminiAPI(prompt, retries = 3, delay = 1000) {
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{
                        parts: [{ "text": prompt }]
                    }],
                    generationConfig: {
                        temperature: 0.7 // From your original code
                    }
                };

                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            const errorBody = await response.json();
                            throw new Error(`API Error ${response.status}: ${errorBody.error.message}`);
                        }

                        const result = await response.json();

                        if (result.candidates && result.candidates.length > 0) {
                            const text = result.candidates[0].content.parts[0].text;
                            return text;
                        } else if (result.promptFeedback) {
                            // Handle content safety blocks
                            const blockReason = result.promptFeedback.blockReason;
                            return `I cannot answer this question. The prompt was blocked for reason: ${blockReason}`;
                        } else {
                            return "I don't know. (Received an empty response from AI)";
                        }

                    } catch (error) {
                        console.error(`Attempt ${i+1} failed:`, error);
                        if (i === retries - 1) { // Last retry
                            throw error; // Re-throw the last error
                        }
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // Exponential backoff
                    }
                }
            }

            // Initial check on load
            checkSetup();
        });
    </script>
</body>
</html>

